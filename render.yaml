version: "1"

services:
  - type: web
    name: ruby-wings-chatbot-v4
    env: python
    plan: standard
    region: singapore
    autoDeploy: true
    branch: main

    healthCheckPath: /api/health
    healthCheckTimeout: 30
    initialDelaySec: 60

    buildCommand: |
      echo "ðŸš€ Ruby Wings build started"

      python -m pip install --upgrade pip setuptools wheel
      pip install -r requirements.txt

      mkdir -p data logs

      if [ ! -f "knowledge.json" ]; then
        echo '{"tours": []}' > knowledge.json
      fi
      echo "âœ… Build done"

    startCommand: |
      echo "ðŸš€ Ruby Wings starting (2GB mode)"

      export RAM_PROFILE=2048
      export FAISS_ENABLED=true
      export GUNICORN_WORKERS=2
      export GUNICORN_THREADS=4

      gunicorn app:app \
        --workers 2 \
        --threads 4 \
        --bind=0.0.0.0:$PORT \
        --timeout 120 \
        --graceful-timeout 30 \
        --keepalive 5 \
        --max-requests 1000 \
        --max-requests-jitter 50 \
        --worker-connections 1000 \
        --log-level info \
        --access-logfile - \
        --error-logfile -

    disk:
      name: ruby-wings-data
      mountPath: /opt/render/project/src/data
      sizeGB: 1

    envVars:
      # ===== RAM / MODE =====
      - key: RAM_PROFILE
        value: "2048"

      # ===== AI =====
      - key: OPENAI_API_KEY
        sync: false
        required: true

      - key: CHAT_MODEL
        value: "gpt-4o-mini"

      - key: EMBEDDING_MODEL
        value: "text-embedding-3-small"

      - key: ENABLE_CACHING
        value: "true"

      - key: TOP_K
        value: "8"

      - key: TIMEOUT
        value: "120"

      # ===== KNOWLEDGE / INDEX =====
      - key: KNOWLEDGE_PATH
        value: "knowledge.json"

      - key: FAISS_ENABLED
        value: "true"

      - key: FAISS_INDEX_PATH
        value: "data/faiss_index.bin"

      - key: FAISS_MAPPING_PATH
        value: "data/faiss_index_meta.json"

      - key: FALLBACK_VECTORS_PATH
        value: "data/vectors.npz"

      - key: ENABLE_FALLBACK_STORAGE
        value: "false"

      # ===== GOOGLE SHEETS =====
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"

      - key: GOOGLE_SERVICE_ACCOUNT_JSON
        sync: false
        required: true

      - key: GOOGLE_SHEET_ID
        value: "1SdVbwkuxb8l1meEW--ddyfh4WmUvSXXMOPQ5bCyPkdk"

      - key: GOOGLE_SHEET_NAME
        value: "RBW_Lead_Raw_Inbox"

      # ===== META =====
      - key: ENABLE_META_CAPI_CALL
        value: "true"

      - key: META_CAPI_TOKEN
        sync: false

      - key: META_PIXEL_ID
        value: "862531473384426"

      # ===== SERVER =====
      - key: PORT
        value: "10000"

      - key: FLASK_ENV
        value: "production"

      - key: DEBUG
        value: "false"

      - key: DEBUG_META_CAPI
        value: "false"

      - key: ENABLE_QUERY_LOGGING
        value: "false"

      - key: SECRET_KEY
        sync: false
        generateValue: true

      # ===== FEATURES =====
      - key: ENABLE_INTENT_DETECTION
        value: "true"

      - key: ENABLE_LOCATION_CONTEXT
        value: "true"

      - key: LOCATION_FILTER_STRICT
        value: "true"

      - key: FEATURE_STATE_MACHINE
        value: "true"

      - key: STATE_MACHINE_ENABLED
        value: "true"

      # ===== UPGRADES =====
      - key: UPGRADE_1_MANDATORY_FILTER
        value: "true"
      - key: UPGRADE_2_DEDUPLICATION
        value: "true"
      - key: UPGRADE_3_ENHANCED_FIELDS
        value: "true"
      - key: UPGRADE_4_QUESTION_PIPELINE
        value: "true"
      - key: UPGRADE_5_QUERY_SPLITTER
        value: "true"
      - key: UPGRADE_6_FUZZY_MATCHING
        value: "true"
      - key: UPGRADE_7_STATE_MACHINE
        value: "true"
      - key: UPGRADE_8_SEMANTIC_ANALYSIS
        value: "true"
      - key: UPGRADE_9_AUTO_VALIDATION
        value: "true"
      - key: UPGRADE_10_TEMPLATE_SYSTEM
        value: "true"

    resources:
      cpu: 2
      memoryMB: 2048

    scaling:
      minInstances: 1
      maxInstances: 2
      targetMemoryPercent: 75
      targetCPUPercent: 70
