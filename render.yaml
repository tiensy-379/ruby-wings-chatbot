version: "1"

services:
  - type: web
    name: ruby-wings-chatbot-v4
    env: python
    plan: standard
    region: singapore
    autoDeploy: true
    branch: main

    healthCheckPath: /api/health
    healthCheckTimeout: 30
    initialDelaySec: 60
    
    startCommand: |
      echo "ðŸš€ Ruby Wings v4.0 Starting..."
      echo "ðŸ”§ Environment: Production"
      echo "ðŸ“Š Memory: 2048MB | Workers: 2 | Threads: 4"
      
      exec gunicorn app:app \
        --workers 2 \
        --threads 4 \
        --bind=0.0.0.0:$PORT \
        --timeout 120 \
        --graceful-timeout 30 \
        --keepalive 5 \
        --max-requests 1000 \
        --max-requests-jitter 50 \
        --worker-connections 1000 \
        --log-level info \
        --access-logfile - \
        --error-logfile -

    buildCommand: |
      echo "ðŸš€ Ruby Wings v4.0 Build Started - FIXED DEPENDENCIES"
      echo "ðŸ“… $(date)"
      echo "ðŸ”§ Python: $(python --version)"
      
      # 1. SET PIP VERSION TO 23.3 (STABLE) - QUAN TRá»ŒNG
      echo "ðŸ“¦ Setting pip to stable version..."
      python -m pip install --upgrade "pip<24.0"
      
      # 2. INSTALL CORE DEPENDENCIES FIRST
      echo "ðŸ“¦ Installing core dependencies..."
      pip install "setuptools<70.0" "wheel<0.44"
      
      # 3. INSTALL NUMPY FIRST (FAISS DEPENDENCY)
      pip install "numpy==1.24.3"
      
      # 4. INSTALL FAISS WITH NO-DEPS THEN DEPS
      echo "ðŸ”§ Installing FAISS (special handling)..."
      pip install "faiss-cpu==1.7.4" --no-deps
      pip install "scipy==1.10.1" "numpy==1.24.3"
      
      # 5. INSTALL OTHER REQUIREMENTS WITH LEGACY RESOLVER
      echo "ðŸ“¦ Installing other requirements..."
      if [ -f "requirements.txt" ]; then
        # Use legacy resolver for compatibility
        pip install --use-deprecated=legacy-resolver -r requirements.txt
      else
        # Fallback to manual install
        pip install "Flask==2.3.3"
        pip install "Flask-CORS==4.0.0"
        pip install "openai==1.3.0"
        pip install "gspread==5.12.0"
        pip install "google-auth==2.23.4"
        pip install "google-auth-httplib2==0.1.0"
        pip install "google-auth-oauthlib==1.0.0"
        pip install "httpx==0.25.1"
        pip install "scikit-learn==1.3.0"
        pip install "pyvi==0.1.1"
        pip install "python-dotenv==1.0.0"
        pip install "gunicorn==21.2.0"
        pip install "requests==2.31.0"
        fi
        
        # 6. CREATE DIRECTORIES
        mkdir -p data logs
        
        # 7. VERIFY KNOWLEDGE.JSON
        echo "ðŸ“ Verifying knowledge.json..."
        if [ ! -f "knowledge.json" ]; then
          echo "âŒ CRITICAL: knowledge.json not found!"
          echo "Files in directory:"
          ls -la
          exit 1
        fi
        
        TOUR_COUNT=$(python -c "import json; d=json.load(open('knowledge.json')); print(len(d.get('tours', [])))")
        echo "âœ… Found $TOUR_COUNT tours in knowledge.json"
        
        if [ "$TOUR_COUNT" -eq 0 ]; then
          echo "âŒ ERROR: No tours found in knowledge.json!"
          exit 1
        fi
        
        # 8. BUILD INDEX
        echo "ðŸ§  Building FAISS index..."
        python build_index.py
        
        echo "âœ… BUILD COMPLETED SUCCESSFULLY"

    startCommand: |
      echo "ðŸš€ Ruby Wings starting (2GB mode)"

      export RAM_PROFILE=2048
      export FAISS_ENABLED=true
      export GUNICORN_WORKERS=2
      export GUNICORN_THREADS=4

      gunicorn app:app \
        --workers 2 \
        --threads 4 \
        --bind=0.0.0.0:$PORT \
        --timeout 120 \
        --graceful-timeout 30 \
        --keepalive 5 \
        --max-requests 1000 \
        --max-requests-jitter 50 \
        --worker-connections 1000 \
        --log-level info \
        --access-logfile - \
        --error-logfile -

    disk:
      name: ruby-wings-data
      mountPath: /opt/render/project/src/data
      sizeGB: 1

    envVars:
      # ===== RAM / MODE =====
      - key: RAM_PROFILE
        value: "2048"

      # ===== AI =====
      - key: OPENAI_API_KEY
        sync: false
        required: true

      - key: CHAT_MODEL
        value: "gpt-4o-mini"

      - key: EMBEDDING_MODEL
        value: "text-embedding-3-small"

      - key: ENABLE_CACHING
        value: "true"

      - key: TOP_K
        value: "8"

      - key: TIMEOUT
        value: "120"

      # ===== KNOWLEDGE / INDEX =====
      - key: KNOWLEDGE_PATH
        value: "knowledge.json"

      - key: FAISS_ENABLED
        value: "true"

      - key: FAISS_INDEX_PATH
        value: "data/faiss_index.bin"

      - key: FAISS_MAPPING_PATH
        value: "data/faiss_mapping.json"

      - key: FALLBACK_VECTORS_PATH
        value: "data/vectors.npz"

      - key: ENABLE_FALLBACK_STORAGE
        value: "false"

      # ===== GOOGLE SHEETS =====
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"

      - key: GOOGLE_SERVICE_ACCOUNT_JSON
        sync: false
        required: true

      - key: GOOGLE_SHEET_ID
        value: "1SdVbwkuxb8l1meEW--ddyfh4WmUvSXXMOPQ5bCyPkdk"

      - key: GOOGLE_SHEET_NAME
        value: "RBW_Lead_Raw_Inbox"

      # ===== META =====
      - key: ENABLE_META_CAPI_CALL
        value: "true"

      - key: META_CAPI_TOKEN
        sync: false

      - key: META_PIXEL_ID
        value: "862531473384426"

      # ===== SERVER =====
      - key: PORT
        value: "10000"

      - key: FLASK_ENV
        value: "production"

      - key: DEBUG
        value: "false"

      - key: DEBUG_META_CAPI
        value: "false"

      - key: ENABLE_QUERY_LOGGING
        value: "false"

      - key: SECRET_KEY
        sync: false
        generateValue: true

      # ===== FEATURES =====
      - key: ENABLE_INTENT_DETECTION
        value: "true"

      - key: ENABLE_LOCATION_CONTEXT
        value: "true"

      - key: LOCATION_FILTER_STRICT
        value: "true"

      - key: FEATURE_STATE_MACHINE
        value: "true"

      - key: STATE_MACHINE_ENABLED
        value: "true"

      # ===== UPGRADES =====
      - key: UPGRADE_1_MANDATORY_FILTER
        value: "true"
      - key: UPGRADE_2_DEDUPLICATION
        value: "true"
      - key: UPGRADE_3_ENHANCED_FIELDS
        value: "true"
      - key: UPGRADE_4_QUESTION_PIPELINE
        value: "true"
      - key: UPGRADE_5_QUERY_SPLITTER
        value: "true"
      - key: UPGRADE_6_FUZZY_MATCHING
        value: "true"
      - key: UPGRADE_7_STATE_MACHINE
        value: "true"
      - key: UPGRADE_8_SEMANTIC_ANALYSIS
        value: "true"
      - key: UPGRADE_9_AUTO_VALIDATION
        value: "true"
      - key: UPGRADE_10_TEMPLATE_SYSTEM
        value: "true"

    resources:
      cpu: 2
      memoryMB: 2048

    scaling:
      minInstances: 1
      maxInstances: 2
      targetMemoryPercent: 75
      targetCPUPercent: 70
