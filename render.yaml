# Ruby Wings Chatbot v5.2.1 - Render Blueprint
# Infrastructure as Code for Render.com deployment

services:
  # ==================== MAIN CHATBOT SERVICE ====================
  - type: web
    name: ruby-wings-chatbot-v5
    runtime: python
    plan: starter  # 512MB RAM - upgrade to standard (2GB) next month
    region: singapore  # Closest to Vietnam
    
    # Build configuration
    buildCommand: pip install --upgrade pip && pip install -r requirements.txt
    startCommand: gunicorn app:app --config gunicorn_conf.py
    
    # Health check
    healthCheckPath: /health
    
    # Auto-deploy
    autoDeploy: true
    
    # Branch to deploy
    branch: main
    
    # Repository (update with your repo)
    # repo: https://github.com/yourusername/ruby-wings-chatbot
    
    # ==================== ENVIRONMENT VARIABLES ====================
    envVars:
      # ==================== CORE API KEYS ====================
      - key: OPENAI_API_KEY
        sync: false  # Set manually in Render dashboard
      
      - key: OPENAI_BASE_URL
        value: https://api.openai.com/v1
      
      - key: EMBEDDING_MODEL
        value: text-embedding-3-small
      
      - key: CHAT_MODEL
        value: gpt-4o-mini
      
      # ==================== META CONVERSION API ====================
      - key: META_PIXEL_ID
        sync: false  # Set manually
      
      - key: META_CAPI_TOKEN
        sync: false  # Set manually
      
      - key: META_TEST_EVENT_CODE
        value: TEST12345
      
      - key: ENABLE_META_CAPI_LEAD
        value: true
      
      - key: ENABLE_META_CAPI_CALL
        value: true
      
      - key: DEBUG_META_CAPI
        value: false  # true for testing, false for production
      
      # ==================== GOOGLE SHEETS ====================
      - key: ENABLE_GOOGLE_SHEETS
        value: true
      
      - key: GOOGLE_SERVICE_ACCOUNT_JSON
        sync: false  # Set manually - JSON string
      
      - key: GOOGLE_SHEET_ID
        sync: false  # Set manually
      
      - key: GOOGLE_SHEET_NAME
        value: RBW_Lead_Raw_Inbox
      
      # ==================== SERVER CONFIGURATION ====================
      - key: FLASK_ENV
        value: production
      
      - key: PORT
        value: 10000
      
      - key: HOST
        value: 0.0.0.0
      
      - key: DEBUG
        value: false
      
      - key: LOG_LEVEL
        value: INFO
      
      - key: TIMEOUT
        value: 60
      
      # ==================== FILE PATHS ====================
      - key: KNOWLEDGE_PATH
        value: knowledge.json
      
      - key: FAISS_ENABLED
        value: false  # true when upgrade to 2GB
      
      - key: FALLBACK_VECTORS_PATH
        value: vectors.npz
      
      - key: FAISS_MAPPING_PATH
        value: faiss_mapping.json
      
      - key: FAISS_INDEX_PATH
        value: faiss_index.bin
      
      - key: TOUR_ENTITIES_PATH
        value: tour_entities.json
      
      # ==================== PERFORMANCE (512MB) ====================
      - key: RAM_PROFILE
        value: 512  # Change to 2048 when upgrading
      
      - key: TOP_K
        value: 5  # Change to 10 when upgrading to 2GB
      
      - key: MAX_CONTENT_LENGTH
        value: 1048576
      
      - key: CACHE_TTL_SECONDS
        value: 300
      
      - key: MAX_SESSIONS
        value: 50  # Change to 100 when upgrading to 2GB
      
      - key: MAX_EMBEDDING_CACHE
        value: 30  # Change to 50 when upgrading to 2GB
      
      - key: CONVERSATION_HISTORY_LIMIT
        value: 5  # Change to 10 when upgrading to 2GB
      
      # ==================== STORAGE ====================
      - key: ENABLE_FALLBACK_STORAGE
        value: true
      
      - key: FALLBACK_STORAGE_PATH
        value: leads_fallback.json
      
      # ==================== SECURITY ====================
      - key: SECRET_KEY
        generateValue: true  # Render auto-generates secure key
      
      # ==================== CORS ====================
      - key: CORS_ORIGINS
        value: https://www.rubywings.vn,https://rubywings.vn
      
      # ==================== GUNICORN ====================
      - key: GUNICORN_WORKERS
        value: 1  # Change to 2 when upgrading to 2GB
      
      - key: GUNICORN_THREADS
        value: 2  # Change to 4 when upgrading to 2GB
      
      - key: PYTHONUNBUFFERED
        value: true
      
      - key: PYTHONMALLOC
        value: malloc
      
      # ==================== FEATURE TOGGLES ====================
      - key: ENABLE_INTENT_DETECTION
        value: true
      
      - key: ENABLE_PHONE_DETECTION
        value: true
      
      - key: ENABLE_LEAD_CAPTURE
        value: true
      
      - key: STATE_MACHINE_ENABLED
        value: true
      
      - key: ENABLE_LOCATION_FILTER
        value: true
      
      - key: ENABLE_SEMANTIC_ANALYSIS
        value: true
    
    # ==================== DISK STORAGE ====================
    disk:
      name: ruby-wings-data
      mountPath: /opt/render/project/src/data
      sizeGB: 1  # 1GB persistent storage for logs and fallback data
    
    # ==================== SCALING ====================
    # Horizontal scaling (available on higher plans)
    # numInstances: 1  # Increase when ready to scale
    
    # ==================== NOTIFICATIONS ====================
    # Get notified on deploy events
    # notifyOnFail: always

# ==================== OPTIONAL: REDIS (for 2GB upgrade) ====================
# Uncomment this section when upgrading to 2GB RAM for better session management
#
# - type: redis
#   name: ruby-wings-redis
#   plan: starter  # Free tier available
#   ipAllowList: []  # Empty = allow from all Render services
#   
#   # Link to main service
#   envVars:
#     - key: REDIS_ENABLED
#       value: true
#       fromService:
#         type: web
#         name: ruby-wings-chatbot-v5

# ==================== OPTIONAL: CRON JOBS ====================
# Uncomment for scheduled tasks
#
# - type: cron
#   name: backup-leads
#   runtime: python
#   schedule: "0 2 * * *"  # Daily at 2 AM
#   buildCommand: pip install -r requirements.txt
#   startCommand: python scripts/backup_leads.py
#   
#   envVars:
#     - key: GOOGLE_SHEET_ID
#       fromService:
#         type: web
#         name: ruby-wings-chatbot-v5
#         envVarKey: GOOGLE_SHEET_ID

# ==================== DATABASES (Future) ====================
# If you need PostgreSQL for advanced features
#
# - type: pstg
#   name: ruby-wings-db
#   plan: starter  # Free tier available
#   databaseName: ruby_wings
#   databaseUser: chatbot
#   
#   ipAllowList: []