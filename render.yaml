services:
  - type: web
    name: ruby-wings-chatbot
    env: python
    plan: starter  # hoặc free nếu dùng free tier
    
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
      if [ "$AUTO_INSTALL_FAISS" = "true" ] && [ "$FAISS_ENABLED" = "true" ]; then
        echo "Installing FAISS..."
        pip install faiss-cpu==1.7.4
      else
        echo "Skipping FAISS installation (AUTO_INSTALL_FAISS=$AUTO_INSTALL_FAISS, FAISS_ENABLED=$FAISS_ENABLED)"
      fi
    
    startCommand: "gunicorn app:app --workers $GUNICORN_WORKERS --threads $GUNICORN_THREADS --bind=0.0.0.0:$PORT --timeout $TIMEOUT --access-logfile -"
    
    envVars:
      # ===== CORE API KEYS =====
      - key: OPENAI_API_KEY
        sync: false
        required: true
      
      - key: OPENAI_BASE_URL
        value: "https://api.openai.com/v1"
      
      # ===== GOOGLE SHEETS =====
      - key: ENABLE_GOOGLE_SHEETS
        value: "true"
      
      - key: GOOGLE_SERVICE_ACCOUNT_JSON
        sync: false
        required: false
      
      - key: GOOGLE_SHEET_ID
        value: "1SdVbwkuxb8l1meEW--ddyfh4WmUvSXXMOPQ5bCyPkdk"
      
      - key: GOOGLE_SHEET_NAME
        value: "RBW_Lead_Raw_Inbox"
      
      # ===== META CAPI =====
      - key: ENABLE_META_CAPI_CALL
        value: "true"
      
      - key: META_CAPI_TOKEN
        sync: false
        required: false
      
      - key: META_PIXEL_ID
        value: "862531473384426"
      
      - key: META_CAPI_ENDPOINT
        value: "https://capig.datah04.com/events"
      
      - key: DEBUG_META_CAPI
        value: "true"
      
      - key: META_TEST_EVENT_CODE
        value: "TEST76123"
      
      # ===== KNOWLEDGE & INDEX =====
      - key: KNOWLEDGE_PATH
        value: "knowledge.json"
      
      - key: FAISS_ENABLED
        value: "false"
      
      - key: AUTO_INSTALL_FAISS
        value: "false"
      
      - key: FAISS_INDEX_PATH
        value: "faiss_index.bin"
      
      - key: FAISS_MAPPING_PATH
        value: "faiss_mapping.json"
      
      - key: FALLBACK_VECTORS_PATH
        value: "vectors.npz"
      
      # ===== MODELS =====
      - key: EMBEDDING_MODEL
        value: "text-embedding-3-small"
      
      - key: CHAT_MODEL
        value: "gpt-4o-mini"
      
      - key: TOP_K
        value: "5"
      
      # ===== STORAGE =====
      - key: ENABLE_FALLBACK_STORAGE
        value: "true"
      
      - key: FALLBACK_STORAGE_PATH
        value: "leads_fallback.json"
      
      # ===== SERVER CONFIG =====
      - key: FLASK_ENV
        value: "production"
      
      - key: DEBUG
        value: "false"
      
      - key: SECRET_KEY
        sync: false
        generateValue: true
      
      - key: CORS_ORIGINS
        value: "https://www.rubywings.vn,https://rubywings.vn"
      
      - key: HOST
        value: "0.0.0.0"
      
      - key: PORT
        value: "10000"
      
      # ===== UPGRADE FEATURE FLAGS =====
      - key: UPGRADE_1_MANDATORY_FILTER
        value: "true"
      
      - key: UPGRADE_2_DEDUPLICATION
        value: "true"
      
      - key: UPGRADE_3_ENHANCED_FIELDS
        value: "true"
      
      - key: UPGRADE_4_QUESTION_PIPELINE
        value: "true"
      
      - key: UPGRADE_5_QUERY_SPLITTER
        value: "true"
      
      - key: UPGRADE_6_FUZZY_MATCHING
        value: "true"
      
      - key: UPGRADE_7_STATE_MACHINE
        value: "true"
      
      - key: UPGRADE_8_SEMANTIC_ANALYSIS
        value: "true"
      
      - key: UPGRADE_9_AUTO_VALIDATION
        value: "true"
      
      - key: UPGRADE_10_TEMPLATE_SYSTEM
        value: "true"
      
      - key: ENABLE_CACHING
        value: "true"
      
      - key: CACHE_TTL_SECONDS
        value: "300"
      
      - key: ENABLE_QUERY_LOGGING
        value: "true"
      
      # ===== ADMIN & SECURITY =====
      - key: RBW_ALLOW_REINDEX
        value: "0"
      
      - key: MAX_CONTENT_LENGTH
        value: "16777216"
      
      # ===== PERFORMANCE =====
      - key: GUNICORN_WORKERS
        value: "1"
      
      - key: GUNICORN_THREADS
        value: "2"
      
      - key: TIMEOUT
        value: "300"
      
      # ===== LOGGING =====
      - key: LOG_LEVEL
        value: "INFO"
    
    healthCheckPath: "/api/health"
    autoDeploy: true
    branch: main
    
    # ===== DISK (nếu cần lưu file tạm) =====
    disk:
      name: data
      mountPath: /opt/render/project/src/data
      sizeGB: 1
    
    # ===== INSTANCE SIZE (phù hợp với 512MB RAM) =====
    instanceType: starter  # tương đương 512MB RAM trên Render